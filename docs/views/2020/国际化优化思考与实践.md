---
title: 国际化优化的思考与实践
date: 2020-08-25
tags:
 - Node
categories:
 - 前端工程化

---

## 背景

国际化是每个需求迭代中一道繁琐但又必须要做的工序，没有任何技术含量，但做起来又感觉非常麻烦，这里列举一下当前我认为的痛点

- 步骤繁琐，目前正常情况下一般需要7步才能完成一个国际化过程
  1. 将需要国际化的中文用i18n.d包裹起来
  2. 跑 npm run extract， 此时temp-zh-words.json就会将待翻译的语句抽取出来
  3. 人工或跑 npm run translate， 通过谷歌翻译自动翻译抽取出来的中文， 翻译结束后在temp-zh-words.json中仔细检查翻译是否符合预期
  4. 再次跑 npm run extract， 此时会自动将翻译好的英文回填到原来的位置，且将.d改为.t
  5. 在所有翻译出来的英文前加上所需的namespace
  6. 跑 npm run locale，会自动将翻译好的内容集合到zh.json和en.json。记得检查有漏翻的情况
  7. 恢复temp-zh-words.json为空文件
- 无法复用之前已经翻译过的内容，比如这次要翻译的是“确定”，如果不想走上面的流程，就需要自行在zh.json中找到”确定“对应的单词和namespace然后手动拼到文件中。
- 如果一个词组，比如”数据模型字段“在一个模块中出现N多次，当产品要求把文案改成”关联模型字段“时，就需要把所有出现的地方都统一改一遍，费事且容易漏改出错
- 由于引入国际化，文案都变成了英文，改起代码来总觉得不直观，找一个文案要先找zh.json的中文，再搜一遍对应的英文，才能找到代码位置，有的时候英文是个比较短的常用词，比如model, 这词在项目中有几百次出现，但中文是有限多个的， 这样就很难定位了。
- 担心长句子因为符号折行，出现NOT_TRANSLATED

<!-- more -->

## 解决思路

Q：如何减少操作步骤？或者通过一个命令将之前所有的步骤打通

A：可以利用`inquirer`这个cli交互库，将所有步骤串联起来，需要使用者人工操作的步骤可以按需暂停。

Q：如何能利用之前翻译过的内容，不做重复劳动？

A：每次检查要翻译的内容都区分为翻译过的内容和从未被翻译过的内容，如果翻译过的内容不符合预期可以再重新移到未翻译的文件中，如果符合预期那么就会自动填充，不用重新翻译。

Q：如何在代码中统一管理翻译后的结果，当文案变更时不需要多处修改

A：可以尝试自动生成一个常量对象，记录所有翻译后的结果，代码中用常量的形式引用翻译后的文案，然后将常量维护在一个公共config文件中

Q：如何让国际化之后的代码也能尽量显示直观的中文，搜索文案时能快速定位？

A：可以尝试把中文也写在上面的常量对象中，利用jsDoc在代码中快速获得对应中文

Q：如何避免长句的翻译出现折行无法正常生成locale文件的情况？

A：以我个人经验，会造成这种情况的符号主要是点和冒号，可以在翻译脚本中强制替换成`&#46;`和`&#58;`来解决



## 方案流程

- 首先还是需要我们和以前一样手动把要翻译的中文用`i18n.d`包裹起来
- 使用命令`npm run i18n`开始执行国际化
- 脚本会将已翻译和未翻译的内容分别写在`temp-translated-words.json`和`temp-zh-words.json`

![image-20200825173610359](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20200825173610359.png)

- 检查已翻译的内容是否符合预期，文件结构如下，如果觉得老的翻译不是想要的，就把这段key的值置空，然后粘贴到`temp-zh-words.json`中去。

```json
{
  "模型名称": "cdp:model name"
}
```

- 按回车后，如果有未翻译的内容就会自动开始谷歌翻译，完成后需要人肉检查结果是否合理，不合理就手动改

![image-20200825174218318](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20200825174218318.png)

- 按回车后，为这次翻译的内容指定一个namespace

![image-20200825174951285](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20200825174951285.png)

- 选择是否要生成I18N的常量片段，

![image-20200825175049105](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20200825175049105.png)

- 如果选择是，就会在`temp-i18n-labels.js`中生成当前所有翻译内容的常量集合

```javascript
const I18N = {
  /**
   * @description 模型名称
   */
  MODEL_NAME: i18n.t('cdp:model name'),
  /**
   * @description 这是一段测试的文案，结果将会被翻译成英文
   */
  THIS_IS_A_TEST_COPY_THE_RESULT: i18n.t('dpCommon:this is a test copy, the result will be translated into English'),
};

```

- 自动替换源文件内容，如果上一步选择是，就会用I18N常量来替换，这里会提示将`temp-i18n-labels.js`中生成的内容手动粘贴到相应的源文件中。 如果选择否就跟我们的原始方案一样

![](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20200825175459722.png)

- 结束之后按回车，选择是否直接清除临时文件，这样就省得手动去删除

![image-20200825175857821](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20200825175857821.png)

- 如果采用常量的方式替换源文件，那么hover在变量上会有中文提示的效果

<img src="https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20200825185350537.png" alt="image-20200825185350537" style="zoom:50%;" />

## 最后

目前在试用了一个礼拜不到，通过复用现有翻译可以解放很大一部分生产力，很多简单的翻译基本只需要按几下回车就完成了，然后如果开发新模块建议可以使用常量的方式管理国际化，将所有翻译集合到一个config文件中，代码看起来干净改起来也可以统一改。

欢迎试用本脚本，如果报错了之前的三个命令`extact/locale/translate`可以照常使用。

具体脚本代码: [MR地址](https://terminus-org.app.terminus.io/workBench/projects/70/apps/1331/repo/mr/open/517)
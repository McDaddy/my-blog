---
title: 【笔记】- 计算机网络
date: 2021-11-09
tags:
 - 网络
categories:
 - 笔记
---

### OSI 七层模型

OSI即`Open System Interconnection`，是一种理想的逻辑分层模型，目的是将复杂的流程简单话。实现专人干专事

<!-- more -->

### 分层的含义

> 层级的意义就是，下层要为上层服务

- 应用层：用户最终使用的接口，

- 表示层：数据的表示、安全、压缩 
- 会话层：建立和管理会话的 
- 传输层：（主要提供安全及数据完整性保障）网络层不可靠，保证可靠的传输 （TCP/UDP）
- 网络层：（主要关心的是寻址），主要保存IP地址，进行逻辑寻址，定位到对方，找到最短的路 
- 数据链路层： （主要关心两个设备之间传递数据），保存网卡的**mac地址**，建立逻辑链接，将数据组合成**数据帧**进行传递 （差错校测，可靠传输） 
- 物理层：核心是传输数据**比特流**，是真正传输数据的，而上面的层都是为了写入对应数据传输信息的（双绞线、光纤、同轴 电缆、无线...）

![image-20211109200134687](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20211109200134687.png)

一次数据传递的流程（四层模型）：

1. 应用层添加**消息**，即真正的传输内容
2. 传输层添加**tcp头部**，形成数据段。所有的通信一定是端口和端口之间的通信，即使在浏览器发起一个请求，能显式看到的只是目标的端口，但实际会分配一个随机端口给发送方
3. 网络层添加**IP**，用于寻址，形成数据包
4. 数据链路层添加**mac地址**信息，形成数据帧



### 协议

协议都是在五层模型的3层及以上，数据链路层（交换机）和物理层（中继器，集线器）被称为物理设备

-   网络层（路由器网关）： 
    -   `IP`协议：可以通过路由器寻址查找，将消息发送给对方的路由器，通过ARP协议，发送自己的**mac地址**
    -   `ARP`协议： Address Resolution Protocol，作用是从ip地址获取mac地址
-   传输层
    -   TCP
    -   UDP
-   应用层
    -   HTTP
    -   DNS
    -   FTP
    -   SMTP
    -   DHCP



#### ARP协议

根据目标的IP地址，得到目标的mac地址，也会把自己的mac地址发送给路由器缓存

在局域网内，或者说在一个网关内，假设A要与B通信，但A只知道B的IP地址，那么就能通过路由器广播给所有节点，B地址收到广播后就会返回自己的mac地址，并且缓存在路由器中，这样下次A要和B通信时，就可以直接通过路由器中缓存的mac地址直接找到B。

![image-20211109150408083](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20211109150408083.png)

#### DHCP协议

通过`DHCP`自动获取网络配置信息 （动态主机配置协议Dynamic Host Configuration Protocol）我们无需自己手动配置`IP`

#### DNS协议

`Domain Name System`的缩写，DNS服务器，就是进行域名与IP转换的服务器

- 顶级域名 .com
- 二级域名 .com.cn
- 三级域名 www.zf.com.cn , 即**有多少个点就是几级域名**

DNS的查找过程（www.zf.com.cn）：

1. 操作系统DNS缓存，缓存命中直接返回IP。这就是为什么本地配了host可能并不能立即生效的原因
2. 查找本地host文件
3. 通过DNS服务器，找到根服务器，得到.cn的服务器IP地址
4. 向.cn的IP发送请求，得到cn下com的ip
5. 如此循环，得到最终的www的ip，并缓存在DNS服务器上



### TCP

TCP是基于连接的协议，它对数据进行分段打包传输，对每个数据包都编号控制顺序

#### 建立连接

![image-20211109164448979](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20211109164448979.png)

- `SYN`表示要建立连接的信号
- `Seq`表示当前自己的序列号
- `ACK`表示确认信号，它是从对方的`Seq + 1` 得到的，并发送回去
- 最终双方的`Seq`都从0到了1，即完成了连接的建立

![image-20211109165044869](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20211109165044869.png)

#### 数据传输

![image-20211109165238219](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20211109165238219.png)

- `PSH`表示推送数据
- `Len`表示这次推送数据的长度
- 不论客户端还是服务器每次接收到非ACK的信号后，都会主动发送一个ACK包表示确认
- 这里的服务器的第一次应答，表示数据收到了，ACK为对方的`Seq + Len`即下一个对方的序列号，同时每次都会带上自己的Seq

![image-20211109173519467](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20211109173519467.png)

如上图，如果一次传输的数据过大，那么TCP就会分包，这里以发送30002个汉字为例

- 在**局域网**每个TCP包能携带的最大字节数是16332。由于在utf8下一个汉字占3个字节，所以总的内容长度是`30002 * 3 = 90006`
- 这里分成了5个包，总长度为`16332 * 4 + 8346 = 90006`
- 每次的`Seq`都会从上次的结束位开始
- 单个包的总大小是16388，其中56是报文头
- 总大小为什么是16388，这是根据网络环境变化的，在大多数情况下，以太网的**最大传输单元**是*1500*，所以如果在英特网上发30002个汉字，将拆分成更多的包

![image-20211109175508307](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20211109175508307.png)

#### 断开连接

![image-20211109191025799](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20211109191025799.png)

为什么需要4次挥手

![image-20211109191520167](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20211109191520167.png)

上图就是一个典型的场景，客户端一次性发送了大量数据给服务端，然后立即主动断开，此时服务端还没处理完成数据，消息都没来得及返回。

- 客户端发出`FIN`包，FIN就是断开连接的信号
- 服务端返回`ACK`包，表示收到FIN
- 接下来服务端连续发了两次数据`PSH`,客户端也响应了两个ACK
- 服务端发出`FIN`，表示数据已经发完，可以断开连接
- 客户端返回`ACK`，正式断开连接

### UDP

`udp` 用户数据报协议 `User Datagram Protoco` ，是一个无连接、不保证可靠性的传输层 协议。你让我发什么就发什么

使用场景： `DHCP`协议、 `DNS` 协议、 `QUIC` 协议等 (处理速度快，可以丢包的情况)

![image-20211109193433532](https://kuimo-markdown-pic.oss-cn-hangzhou.aliyuncs.com/image-20211109193433532.png)

从抓包来看就比较简单，一次数据传递就是一条记录，不需要连接，速度很快



### 滑动窗口

- 滑动窗口：TCP是全双工的，所以发送端有发送缓存区，接收端有接收缓存区。要发送的数据都放到发送者的缓存区，发送窗口（要被发送的数据）就是要发送缓存中的那一部分



### 粘包

